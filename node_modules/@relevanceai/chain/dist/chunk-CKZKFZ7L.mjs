var u=Symbol("VARIABLE_INTERNAL"),I={get(r,t){let e=m(r);if(["toString","toJSON","valueOf",Symbol.toPrimitive].includes(t))return()=>`{{${e}}}`;if(typeof t=="string"||typeof t=="number"){let n=t==="*"?`${e}[${t}]`:`${e}.${t}`;return o({path:n})}return t===u?r[u]:null}},o=r=>new Proxy({[u]:{path:r.path}},I);var m=r=>r[u].path,y=r=>m(r).split(".").join("?.");import*as h from"dotenv";var b=!1,g=r=>{b&&!r||(h.config(),h.config({path:"./chains/.relevance"}),b=!0)},T=()=>({project:process.env.RELEVANCE_PROJECT_ID||"",region:process.env.RELEVANCE_REGION||"",apiKey:process.env.RELEVANCE_API_KEY||""});var l=class{constructor(t){g();let e=t!=null?t:T();if(!e.project||!e.region||!e.apiKey)throw new Error("Missing auth details. Please provide a project ID, region, and API key.");this.authDetails=e}get token(){return`${this.authDetails.project}:${this.authDetails.apiKey}:${this.authDetails.region}`}async request(t,e){let n=e!=null&&e.query?new URLSearchParams(Object.fromEntries(Object.entries(e.query).map(([s,p])=>[s,typeof p=="object"?JSON.stringify(p):p]))):"",i=`https://api-${this.authDetails.region}.stack.tryrelevance.com/latest${t}?${n}`,a=await fetch(i,{...e,headers:{...e==null?void 0:e.headers,Authorization:this.token}});if(!a.ok){let s=await a.text();try{s=JSON.parse(s).message||s}catch{}throw new d(s)}return a.json()}async getChain(t,e){return(await this.request(`/studios/${t}`)).studio}async runChain(t){return await this.request(`/studios/${t.studio_id}/trigger`,{method:"POST",body:JSON.stringify(t)})}async saveChains(t){var n;return await this.request("/studios/bulk_update",{method:"POST",body:JSON.stringify({...t,partial_update:(n=t.partial_update)!=null?n:!0})})}async getChainsByIds(t){return(await this.request("/studios/list",{query:{filters:[{filter_type:"exact_match",field:"studio_id",condition_value:t},{filter_type:"exact_match",field:"project",condition_value:this.authDetails.project}]}})).results}async shareChain(t){return await this.request(`/studios/${t}/get_share_link`,{method:"POST"})}async unshareChain(t,e){await this.request(`/studios/${t}/delete_share_link`,{method:"POST",body:JSON.stringify({share_id:e})})}},d=class extends Error{constructor(t){super(t)}};var P=r=>JSON.parse(JSON.stringify(r));import{ZodType as O}from"zod";import{zodToJsonSchema as x}from"zod-to-json-schema";var C=r=>{let t=x(r);return delete t.$schema,t},q=r=>r,F=(r,t={})=>({...C(r),...t}),f=class{constructor(t){this.$RELEVANCE_CHAIN_BRAND=!0;this.chainId=null;this.params=null;this.steps=[];this.output=null;this.title="";this.description="";this.publiclyTriggerable=!1;this.runIfContext=null;this.foreachContext=null;this.api=new l(t)}setTitle(t){this.title=t}setDescription(t){this.description=t}setPubliclyTriggerable(t){this.publiclyTriggerable=t}defineParams(t){if(this.params)throw new Error("Params already defined. If you want to add more params, add them in the initial defineParams call.");return this.params=Object.fromEntries(Object.entries(t).map(([e,n])=>n instanceof O?[e,C(n)]:[e,n])),o({path:"params"})}step(t,e){let n=t,i=this.steps.filter(s=>s.transformation===t);i.length&&(n=`${t}_${i.length+1}`);let a={name:n,transformation:t,params:e};return this.runIfContext!==null&&(a.if=this.runIfContext),this.foreachContext!==null&&(a.foreach=this.foreachContext),this.steps.push(a),o({path:`steps.${n}.output`})}runIf(t,e){if(this.runIfContext)throw new Error("Nested runIf not supported at the moment.");this.runIfContext=t;let n=e();return this.runIfContext=null,n}code(t,e){let n=Object.entries(t).map(([s,p])=>`${JSON.stringify(s)}: ${y(p)}`).join(","),i=e.toString(),a=`
return (() => {
  const _$$params = { ${n} };
  return (${i})(_$$params);
})();`.trim();return this.step("js_code_transformation",{code:a})}foreach(t,e){if(this.foreachContext)throw new Error("Nested foreach not supported at the moment.");this.foreachContext=t;let n=this.steps.length;if(e({item:o({path:"foreach.item"}),index:o({path:"foreach.index"})}),this.steps.length-n!==1)throw new Error("You must call `step` once and only once inside the `foreach` callback.");this.foreachContext=null;let a=this.steps[this.steps.length-1];return o({path:`steps.${a.name}.results`})}defineOutput(t){if(this.output)throw new Error("Output already defined. If you want to add more output, add them in the initial defineOutput call.");this.output=t}toJSON(){return P({studio_id:this.chainId||"LOCAL_DEV_CHAIN",title:this.title,description:this.description,params_schema:{properties:this.params||{}},transformations:{steps:this.steps,output:this.output},publicly_triggerable:this.publiclyTriggerable})}setChainId(t){this.chainId=t}getChainId(){return this.chainId}async run(t){let e=this.toJSON();return await this.api.runChain({studio_id:e.studio_id,params:t,return_state:!0,studio_override:e})}},c=f;c.define=t=>{var a;let e=new f,n=e.defineParams(t.params||{});t.title&&e.setTitle(t.title),t.description&&e.setDescription(t.description),e.setPubliclyTriggerable((a=t.publiclyTriggerable)!=null?a:!1);let i=t.setup({params:n,step:e.step.bind(e),runIf:e.runIf.bind(e),code:e.code.bind(e),foreach:e.foreach.bind(e)});return i&&e.defineOutput(i),e};var k=c.define;export{T as a,l as b,q as c,F as d,c as e,k as f};
